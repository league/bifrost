
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7. Fast GPU math using bfMap &#8212; bifrost 0.6 documentation</title>
    <link rel="stylesheet" type="text/css" href="static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="static/documentation_options.js"></script>
    <script src="static/jquery.js"></script>
    <script src="static/underscore.js"></script>
    <script src="static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. How bifrost fits together" href="How-Python-and-C---fits-together.html" />
    <link rel="prev" title="6. Monitoring Tools" href="tools-intro.html" />
   
  <link rel="stylesheet" href="static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="fast-gpu-math-using-bfmap">
<h1><span class="section-number">7. </span>Fast GPU math using bfMap<a class="headerlink" href="#fast-gpu-math-using-bfmap" title="Permalink to this headline">¶</a></h1>
<p>A key under-the-hood part of <code class="docutils literal notranslate"><span class="pre">bifrost</span></code> is the <code class="docutils literal notranslate"><span class="pre">map</span></code> function, that
provides a simple way to do fast arithmetic operations on the GPU. To
get acquainted, we will ignore all of the pipeline infrastructure that
bifrost provides, and just call the map function directly.</p>
<p>Let’s suppose you have two <code class="docutils literal notranslate"><span class="pre">ndarrays</span></code> and wish to add them together on
the GPU. Here is how you would do that with <code class="docutils literal notranslate"><span class="pre">map</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bifrost</span> <span class="k">as</span> <span class="nn">bf</span>

<span class="c1"># Create two arrays on the GPU, A and B, and an empty output C</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">ndarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">space</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">ndarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">space</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">space</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>

<span class="c1"># Add them together</span>
<span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c = a + b&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
<span class="nb">print</span> <span class="n">c</span>
<span class="c1"># ndarray([ 2.,  2.,  4.,  4.,  6.])</span>
</pre></div>
</div>
<p>The map function figures out what to do based on the string you give it.
These would also work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c = a - b&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
<span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c = a * b&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
<span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c = a / b&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
<span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c += a + b&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
<span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c /= a + b&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
<span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c *= a + b&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
</pre></div>
</div>
<p>Getting deeper requires a look at the docstring:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="n">func_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply a function to a set of ndarrays.</span>

<span class="sd">    Args:</span>
<span class="sd">      func_string (str): The function to apply to the arrays, as a string (see</span>
<span class="sd">                   below for examples).</span>
<span class="sd">      data (dict): Map of string names to ndarrays or scalars.</span>
<span class="sd">      axis_names (list): List of string names by which each axis is referenced</span>
<span class="sd">                   in func_string.</span>
<span class="sd">      shape:       The shape of the computation. If None, the broadcast shape</span>
<span class="sd">                   of all data arrays is used.</span>
<span class="sd">      func_name (str): Name of the function, for debugging purposes.</span>
<span class="sd">      extra_code (str): Additional code to be included at global scope.</span>
<span class="sd">      block_shape: The 2D shape of the thread block (y,x) with which the kernel</span>
<span class="sd">                   is launched.</span>
<span class="sd">                   This is a performance tuning parameter.</span>
<span class="sd">                   If NULL, a heuristic is used to select the block shape.</span>
<span class="sd">                   Changes to this parameter do _not_ require re-compilation of</span>
<span class="sd">                   the kernel.</span>
<span class="sd">      block_axes:  List of axis indices (or names) specifying the 2 computation</span>
<span class="sd">                   axes to which the thread block (y,x) is mapped.</span>
<span class="sd">                   This is a performance tuning parameter.</span>
<span class="sd">                   If NULL, a heuristic is used to select the block axes.</span>
<span class="sd">                   Values may be negative for reverse indexing.</span>
<span class="sd">                   Changes to this parameter _do_ require re-compilation of the</span>
<span class="sd">                   kernel.</span>

<span class="sd">    Note:</span>
<span class="sd">        Only GPU computation is currently supported.</span>

<span class="sd">    Examples::</span>

<span class="sd">      # Add two arrays together</span>
<span class="sd">      bf.map(&quot;c = a + b&quot;, {&#39;c&#39;: c, &#39;a&#39;: a, &#39;b&#39;: b})</span>

<span class="sd">      # Compute outer product of two arrays</span>
<span class="sd">      bf.map(&quot;c(i,j) = a(i) * b(j)&quot;,</span>
<span class="sd">             {&#39;c&#39;: c, &#39;a&#39;: a, &#39;b&#39;: b},</span>
<span class="sd">             axis_names=(&#39;i&#39;,&#39;j&#39;))</span>

<span class="sd">      # Split the components of a complex array</span>
<span class="sd">      bf.map(&quot;a = c.real; b = c.imag&quot;, {&#39;c&#39;: c, &#39;a&#39;: a, &#39;b&#39;: b})</span>

<span class="sd">      # Raise an array to a scalar power</span>
<span class="sd">      bf.map(&quot;c = pow(a, p)&quot;, {&#39;c&#39;: c, &#39;a&#39;: a, &#39;p&#39;: 2.0})</span>

<span class="sd">      # Slice an array with a scalar index</span>
<span class="sd">      bf.map(&quot;c(i) = a(i,k)&quot;, {&#39;c&#39;: c, &#39;a&#39;: a, &#39;k&#39;: 7}, [&#39;i&#39;], shape=c.shape)</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Let’s look a bit closer at that outer product example. Here, by
convention of summation notation, the indexes ‘i’, ‘j’ on the two arrays
A and B, create an outer product. A full example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bifrost</span> <span class="k">as</span> <span class="nn">bf</span>

<span class="c1"># Create two arrays on the GPU, A and B, and an empty output C</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">ndarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">space</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">ndarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">space</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">space</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>

<span class="c1"># Compute outer product</span>
<span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c(i,j) = a(i) * b(j)&quot;</span><span class="p">,</span>
       <span class="n">axis_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">],</span>
       <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
<span class="nb">print</span> <span class="n">c</span>

<span class="c1"># ndarray([[ 1.,  0.,  1.,  0.,  1.],</span>
<span class="c1">#          [ 2.,  0.,  2.,  0.,  2.],</span>
<span class="c1">#          [ 3.,  0.,  3.,  0.,  3.],</span>
<span class="c1">#          [ 4.,  0.,  4.,  0.,  4.],</span>
<span class="c1">#          [ 5.,  0.,  5.,  0.,  5.]])</span>
</pre></div>
</div>
<p>The first example of <code class="docutils literal notranslate"><span class="pre">c</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code> could also be written more explicitly as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bf</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;c(i) = a(i) + b(i)&quot;</span><span class="p">,</span> <span class="n">axis_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">})</span>
</pre></div>
</div>
<p>Note, however, that implicit indexing should be preferred where possible, as
explicit indexing may exhibit worse performance.</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">bifrost</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduction to Bifrost</a></li>
<li class="toctree-l1"><a class="reference internal" href="Getting-started-guide.html">2. Getting started guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Create-a-pipeline.html">3. Create a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="your-first-blocks.html">4. Your first blocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="views.html">5. Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools-intro.html">6. Monitoring Tools</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">7. Fast GPU math using bfMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="How-Python-and-C---fits-together.html">8. How bifrost fits together</a></li>
<li class="toctree-l1"><a class="reference internal" href="Common-installation-and-execution-problems.html">9. Common Installation and Execution Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="bifrost.blocks.html">10. Block Library Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="bifrost.html">11. Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="Cpp-Development.html">12. C++ Developement</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_reference.html">13. C++ Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="tools-intro.html" title="previous chapter"><span class="section-number">6. </span>Monitoring Tools</a></li>
      <li>Next: <a href="How-Python-and-C---fits-together.html" title="next chapter"><span class="section-number">8. </span>How bifrost fits together</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;1980, ledatelescope.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="sources/bfmap.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>