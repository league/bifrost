
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bifrost.pipeline &#8212; bifrost 0.6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bifrost.pipeline</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># Copyright (c) 2016-2021, The Bifrost Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions</span>
<span class="c1"># are met:</span>
<span class="c1"># * Redistributions of source code must retain the above copyright</span>
<span class="c1">#   notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># * Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#   notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#   documentation and/or other materials provided with the distribution.</span>
<span class="c1"># * Neither the name of The Bifrost Authors nor the names of its</span>
<span class="c1">#   contributors may be used to endorse or promote products derived</span>
<span class="c1">#   from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS&#39;&#39; AND ANY</span>
<span class="c1"># EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="c1"># PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR</span>
<span class="c1"># CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
<span class="c1"># EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span>
<span class="c1"># PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span>
<span class="c1"># PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY</span>
<span class="c1"># OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="c1"># (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1"># OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="c1"># Python2 compatibility</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
    <span class="nb">range</span> <span class="o">=</span> <span class="n">xrange</span>
    
<span class="kn">import</span> <span class="nn">threading</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">queue</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span> <span class="k">as</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ExitStack</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">contextlib2</span> <span class="kn">import</span> <span class="n">ExitStack</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">bifrost</span> <span class="kn">import</span> <span class="n">device</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">affinity</span>
<span class="kn">from</span> <span class="nn">bifrost.ring2</span> <span class="kn">import</span> <span class="n">Ring</span><span class="p">,</span> <span class="n">ring_view</span>
<span class="kn">from</span> <span class="nn">bifrost.temp_storage</span> <span class="kn">import</span> <span class="n">TempStorage</span>
<span class="kn">from</span> <span class="nn">bifrost.proclog</span> <span class="kn">import</span> <span class="n">ProcLog</span>
<span class="kn">from</span> <span class="nn">bifrost.ndarray</span> <span class="kn">import</span> <span class="n">memset_array</span> <span class="c1"># TODO: This feels a bit hacky</span>
<span class="kn">from</span> <span class="nn">bifrost.libbifrost</span> <span class="kn">import</span> <span class="n">EndOfDataStop</span>

<span class="kn">from</span> <span class="nn">bifrost</span> <span class="kn">import</span> <span class="n">telemetry</span>
<span class="n">telemetry</span><span class="o">.</span><span class="n">track_module</span><span class="p">()</span>

<span class="c1"># Note: This must be called before any devices are initialized. It&#39;s also</span>
<span class="c1">#          almost always desirable when running pipelines, so we do it here at</span>
<span class="c1">#          module import time to make things easy.</span>
<span class="n">device</span><span class="o">.</span><span class="n">set_devices_no_spin_cpu</span><span class="p">()</span>

<div class="viewcode-block" id="izip"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.izip">[docs]</a><span class="k">def</span> <span class="nf">izip</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">iterables</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">EndOfDataStop</span><span class="p">,</span> <span class="ne">StopIteration</span><span class="p">):</span>
            <span class="k">return</span></div>

<span class="n">thread_local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
<span class="n">thread_local</span><span class="o">.</span><span class="n">pipeline_stack</span> <span class="o">=</span> <span class="p">[]</span>
<div class="viewcode-block" id="get_default_pipeline"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.get_default_pipeline">[docs]</a><span class="k">def</span> <span class="nf">get_default_pipeline</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">thread_local</span><span class="o">.</span><span class="n">pipeline_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<span class="n">thread_local</span><span class="o">.</span><span class="n">blockscope_stack</span> <span class="o">=</span> <span class="p">[]</span>
<div class="viewcode-block" id="get_current_block_scope"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.get_current_block_scope">[docs]</a><span class="k">def</span> <span class="nf">get_current_block_scope</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thread_local</span><span class="o">.</span><span class="n">blockscope_stack</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">thread_local</span><span class="o">.</span><span class="n">blockscope_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="block_scope"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.block_scope">[docs]</a><span class="k">def</span> <span class="nf">block_scope</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">BlockScope</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="BlockScope"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.BlockScope">[docs]</a><span class="k">class</span> <span class="nc">BlockScope</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">instance_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">gulp_nframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">buffer_nframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">buffer_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">core</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">gpu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">share_temp_storage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">fuse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;BlockScope_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">BlockScope</span><span class="o">.</span><span class="n">instance_count</span>
            <span class="n">BlockScope</span><span class="o">.</span><span class="n">instance_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gulp_nframe</span>   <span class="o">=</span> <span class="n">gulp_nframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_nframe</span> <span class="o">=</span> <span class="n">buffer_nframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer_factor</span> <span class="o">=</span> <span class="n">buffer_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_core</span>          <span class="o">=</span> <span class="n">core</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gpu</span>           <span class="o">=</span> <span class="n">gpu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_share_temp_storage</span> <span class="o">=</span> <span class="n">share_temp_storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_storage_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fused</span> <span class="o">=</span> <span class="n">fuse</span>
        <span class="k">if</span> <span class="n">fuse</span><span class="p">:</span>
            <span class="c1">#if self._buffer_factor is None:</span>
            <span class="c1">#    self._buffer_factor = 1.0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_temp_storage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_share_temp_storage</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_scope</span> <span class="o">=</span> <span class="n">get_current_block_scope</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_scope</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_scope</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_children</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thread_local</span><span class="o">.</span><span class="n">blockscope_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="n">popped</span> <span class="o">=</span> <span class="n">thread_local</span><span class="o">.</span><span class="n">blockscope_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">popped</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># Use child&#39;s value if set, othersize defer to parent</span>
        <span class="k">if</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">self_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_scope</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">_get_temp_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">space</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_storage_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_storage_</span><span class="p">[</span><span class="n">space</span><span class="p">]</span> <span class="o">=</span> <span class="n">TempStorage</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_storage_</span><span class="p">[</span><span class="n">space</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_get_scope_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of BlockScopes from root ancestor to self&quot;&quot;&quot;</span>
        <span class="n">scope_hierarchy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_scope</span>
        <span class="k">while</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scope_hierarchy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_parent_scope</span>
        <span class="k">return</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">scope_hierarchy</span><span class="p">)</span>
<div class="viewcode-block" id="BlockScope.cache_scope_hierarchy"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.BlockScope.cache_scope_hierarchy">[docs]</a>    <span class="k">def</span> <span class="nf">cache_scope_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope_hierarchy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scope_hierarchy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fused_ancestor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope_hierarchy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">_fused</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fused_ancestor</span> <span class="o">=</span> <span class="n">ancestor</span>
                <span class="k">break</span></div>
<div class="viewcode-block" id="BlockScope.is_fused_with"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.BlockScope.is_fused_with">[docs]</a>    <span class="k">def</span> <span class="nf">is_fused_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fused_ancestor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fused_ancestor</span> <span class="ow">is</span> <span class="n">other</span><span class="o">.</span><span class="n">fused_ancestor</span><span class="p">)</span></div>
<div class="viewcode-block" id="BlockScope.get_temp_storage"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.BlockScope.get_temp_storage">[docs]</a>    <span class="k">def</span> <span class="nf">get_temp_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
        <span class="c1"># TODO: Cache the first share_temp_storage scope to avoid walking each time</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope_hierarchy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scope</span><span class="o">.</span><span class="n">share_temp_storage</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">scope</span><span class="o">.</span><span class="n">_get_temp_storage</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_temp_storage</span><span class="p">(</span><span class="n">space</span><span class="p">)</span></div>
<div class="viewcode-block" id="BlockScope.dot_graph"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.BlockScope.dot_graph">[docs]</a>    <span class="k">def</span> <span class="nf">dot_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_graph</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Digraph</span>

        <span class="c1">#graph_attr = {&#39;label&#39;: self._name}</span>
        <span class="n">graph_attr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">parent_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="s1">&#39;cluster_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">graph_attr</span><span class="o">=</span><span class="n">graph_attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">parent_graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="s1">&#39;cluster_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                                      <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Block</span><span class="p">):</span>
                <span class="n">block</span> <span class="o">=</span> <span class="n">child</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">block_colors</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
                <span class="n">block_colors</span><span class="p">[</span><span class="s1">&#39;CopyBlock&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightsteelblue&#39;</span>
                <span class="n">block_type</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">fillcolor</span> <span class="o">=</span> <span class="n">block_colors</span><span class="p">[</span><span class="n">block_type</span><span class="p">]</span>
                <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                       <span class="c1">#label=&#39;%s: %s&#39; % (block.type,block.name),</span>
                       <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                       <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span>
                       <span class="n">style</span><span class="o">=</span><span class="s1">&#39;filled&#39;</span><span class="p">,</span>
                       <span class="n">fillcolor</span><span class="o">=</span><span class="n">fillcolor</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">oring</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">orings</span><span class="p">:</span>
                    <span class="n">space_colors</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;system&#39;</span><span class="p">:</span>    <span class="s1">&#39;orange&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>      <span class="s1">&#39;limegreen&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;cuda_host&#39;</span><span class="p">:</span> <span class="s1">&#39;deepskyblue&#39;</span>
                    <span class="p">}</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">oring</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;ellipse&#39;</span><span class="p">,</span>
                           <span class="n">style</span><span class="o">=</span><span class="s1">&#39;filled&#39;</span><span class="p">,</span>
                           <span class="n">fillcolor</span><span class="o">=</span><span class="n">space_colors</span><span class="p">[</span><span class="n">oring</span><span class="o">.</span><span class="n">space</span><span class="p">])</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">oring</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iring</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">irings</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">iring</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#child.dot_graph(g)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">dot_graph</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">g</span></div></div>

<div class="viewcode-block" id="try_join"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.try_join">[docs]</a><span class="k">def</span> <span class="nf">try_join</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span></div>
<span class="c1"># Utility function for joining a collection of threads with a timeout</span>
<div class="viewcode-block" id="join_all"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.join_all">[docs]</a><span class="k">def</span> <span class="nf">join_all</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
    <span class="n">alive_threads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">alive_threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">alive_threads</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">try_join</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>
        <span class="n">available_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">deadline</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alive_threads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
            <span class="n">available_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">alive_threads</span>
        <span class="n">alive_threads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="PipelineInitError"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.PipelineInitError">[docs]</a><span class="k">class</span> <span class="nc">PipelineInitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="Pipeline"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Pipeline">[docs]</a><span class="k">class</span> <span class="nc">Pipeline</span><span class="p">(</span><span class="n">BlockScope</span><span class="p">):</span>
    <span class="n">instance_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Pipeline_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">instance_count</span>
            <span class="n">Pipeline</span><span class="o">.</span><span class="n">instance_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_timeout</span> <span class="o">=</span> <span class="mf">5.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_blocks_finished_initializing_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_init_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<div class="viewcode-block" id="Pipeline.as_default"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Pipeline.as_default">[docs]</a>    <span class="k">def</span> <span class="nf">as_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PipelineContext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
<div class="viewcode-block" id="Pipeline.synchronize_block_initializations"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Pipeline.synchronize_block_initializations">[docs]</a>    <span class="k">def</span> <span class="nf">synchronize_block_initializations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Wait for all blocks to finish initializing</span>
        <span class="n">uninitialized_blocks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">uninitialized_blocks</span><span class="p">):</span>
            <span class="c1"># Note: This will get stuck if a transform block has no input ring</span>
            <span class="n">block</span><span class="p">,</span> <span class="n">init_succeeded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_init_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">uninitialized_blocks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">init_succeeded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">PipelineInitError</span><span class="p">(</span>
                    <span class="s2">&quot;The following block failed to initialize: &quot;</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Tell blocks that they can begin data processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_blocks_finished_initializing_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>
<div class="viewcode-block" id="Pipeline.run"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Pipeline.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Launch blocks as threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchronize_block_initializations</span><span class="p">()</span>
        <span class="c1"># Wait for blocks to finish processing</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="c1"># Note: Doing it this way allows signals to be caught here</span>
            <span class="k">while</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">)</span></div>
<div class="viewcode-block" id="Pipeline.shutdown"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Pipeline.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="n">block</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="c1"># Ensure all blocks can make progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_blocks_finished_initializing_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">join_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown_timeout</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Thread </span><span class="si">%s</span><span class="s2"> did not shut down on time and will be killed&quot;</span> <span class="o">%</span> <span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span></div>
<div class="viewcode-block" id="Pipeline.shutdown_on_signals"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Pipeline.shutdown_on_signals">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown_on_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">signals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">,</span>
                       <span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span>
                       <span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">,</span>
                       <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span>
                       <span class="n">signal</span><span class="o">.</span><span class="n">SIGTSTP</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_signal_shutdown</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_handle_signal_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">SIGNAL_NAMES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span>
                            <span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SIG&#39;</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SIG_&#39;</span><span class="p">))</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Received signal </span><span class="si">%i</span><span class="s2"> </span><span class="si">%s</span><span class="s2">, shutting down pipeline&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">SIGNAL_NAMES</span><span class="p">[</span><span class="n">signum</span><span class="p">]),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thread_local</span><span class="o">.</span><span class="n">pipeline_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="n">popped</span> <span class="o">=</span> <span class="n">thread_local</span><span class="o">.</span><span class="n">pipeline_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">popped</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">)</span></div>

<span class="c1"># Create the default pipeline object</span>
<span class="n">thread_local</span><span class="o">.</span><span class="n">pipeline_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">())</span>
<span class="n">thread_local</span><span class="o">.</span><span class="n">blockscope_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_default_pipeline</span><span class="p">())</span>

<div class="viewcode-block" id="get_ring"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.get_ring">[docs]</a><span class="k">def</span> <span class="nf">get_ring</span><span class="p">(</span><span class="n">block_or_ring</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">block_or_ring</span><span class="o">.</span><span class="n">orings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">block_or_ring</span></div>

<div class="viewcode-block" id="block_view"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.block_view">[docs]</a><span class="k">def</span> <span class="nf">block_view</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">header_transform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;View a block with modified output headers</span>

<span class="sd">    Use this function to adjust the output headers of a ring</span>
<span class="sd">    on-the-fly, effectively producing a new &#39;view&#39; of the block.</span>

<span class="sd">    Args:</span>
<span class="sd">        block (Block): Input block.</span>
<span class="sd">        header_transform (function): A function f(hdr) -&gt; new_hdr.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new block that acts as the old block but modifies its sequence</span>
<span class="sd">        headers on-the-fly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_block</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="n">new_block</span><span class="o">.</span><span class="n">orings</span> <span class="o">=</span> <span class="p">[</span><span class="n">ring_view</span><span class="p">(</span><span class="n">oring</span><span class="p">,</span> <span class="n">header_transform</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">oring</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">orings</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_block</span></div>

<div class="viewcode-block" id="Block"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block">[docs]</a><span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="n">BlockScope</span><span class="p">):</span>
    <span class="n">instance_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irings</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">type_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type_</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Block</span><span class="o">.</span><span class="n">instance_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">])</span>
        <span class="n">Block</span><span class="o">.</span><span class="n">instance_counts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Block</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">get_default_pipeline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Allow Block instances to be passed in place of rings</span>
        <span class="n">irings</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_ring</span><span class="p">(</span><span class="n">iring</span><span class="p">)</span> <span class="k">for</span> <span class="n">iring</span> <span class="ow">in</span> <span class="n">irings</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irings</span> <span class="o">=</span> <span class="n">irings</span>
        <span class="n">valid_inp_spaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_define_valid_input_spaces</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">iring</span><span class="p">,</span> <span class="n">valid_spaces</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">irings</span><span class="p">,</span> <span class="n">valid_inp_spaces</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">memory</span><span class="o">.</span><span class="n">space_accessible</span><span class="p">(</span><span class="n">iring</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="n">valid_spaces</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Block </span><span class="si">%s</span><span class="s2"> input </span><span class="si">%i</span><span class="s2">&#39;s space must be accessible from one of: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">valid_spaces</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orings</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Update this in subclass constructors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_proclog</span> <span class="o">=</span> <span class="n">ProcLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/bind&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_proclog</span> <span class="o">=</span> <span class="n">ProcLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/in&quot;</span><span class="p">)</span>

        <span class="n">rnames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nring&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">):</span>
            <span class="n">rnames</span><span class="p">[</span><span class="s1">&#39;ring</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_proclog</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rnames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_trace</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<div class="viewcode-block" id="Block.shutdown"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>
<div class="viewcode-block" id="Block.create_ring"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.create_ring">[docs]</a>    <span class="k">def</span> <span class="nf">create_ring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Ring</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="Block.run"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#affinity.set_openmp_cores(cpus) # TODO</span>
        <span class="n">core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core</span>
        <span class="k">if</span> <span class="n">core</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">affinity</span><span class="o">.</span><span class="n">set_core</span><span class="p">(</span><span class="n">core</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">core</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_proclog</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ncore&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="s1">&#39;core0&#39;</span><span class="p">:</span> <span class="n">affinity</span><span class="o">.</span><span class="n">get_core</span><span class="p">()})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_scope_hierarchy</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">oring_stack</span><span class="p">:</span>
            <span class="n">active_orings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_writing</span><span class="p">(</span><span class="n">oring_stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orings</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">active_orings</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">block_init_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;From block instantiated here:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_trace</span><span class="p">)</span>
                <span class="k">raise</span></div>
<div class="viewcode-block" id="Block.num_outputs"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.num_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">num_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: This is a little hacky</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orings</span><span class="p">)</span></div>
<div class="viewcode-block" id="Block.begin_writing"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.begin_writing">[docs]</a>    <span class="k">def</span> <span class="nf">begin_writing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_stack</span><span class="p">,</span> <span class="n">orings</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">exit_stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">oring</span><span class="o">.</span><span class="n">begin_writing</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">oring</span> <span class="ow">in</span> <span class="n">orings</span><span class="p">]</span></div>
<div class="viewcode-block" id="Block.begin_sequences"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.begin_sequences">[docs]</a>    <span class="k">def</span> <span class="nf">begin_sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_stack</span><span class="p">,</span> <span class="n">orings</span><span class="p">,</span> <span class="n">oheaders</span><span class="p">,</span>
                        <span class="n">igulp_nframes</span><span class="p">,</span> <span class="n">istride_nframes</span><span class="p">):</span>
        <span class="c1"># Note: The gulp_nframe that is set in the output header does not</span>
        <span class="c1">#         include the overlap (i.e., it&#39;s based on stride not gulp).</span>
        <span class="n">ostride_nframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_define_output_nframes</span><span class="p">(</span><span class="n">istride_nframes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ohdr</span><span class="p">,</span> <span class="n">ostride_nframe</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">oheaders</span><span class="p">,</span> <span class="n">ostride_nframes</span><span class="p">):</span>
            <span class="n">ohdr</span><span class="p">[</span><span class="s1">&#39;gulp_nframe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ostride_nframe</span>
        <span class="n">ogulp_nframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_define_output_nframes</span><span class="p">(</span><span class="n">igulp_nframes</span><span class="p">)</span>
        <span class="c1"># Note: This always specifies buffer_factor=1 on the assumption that</span>
        <span class="c1">#         additional buffering is defined by the reader(s) rather</span>
        <span class="c1">#         than the writer.</span>
        <span class="n">obuf_nframes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">*</span> <span class="n">ogulp_nframe</span> <span class="k">for</span> <span class="n">ogulp_nframe</span> <span class="ow">in</span> <span class="n">ogulp_nframes</span><span class="p">]</span>
        <span class="n">oseqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">exit_stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">oring</span><span class="o">.</span><span class="n">begin_sequence</span><span class="p">(</span><span class="n">ohdr</span><span class="p">,</span>
                                                               <span class="n">ogulp_nframe</span><span class="p">,</span>
                                                               <span class="n">obuf_nframe</span><span class="p">))</span>
                 <span class="k">for</span> <span class="p">(</span><span class="n">oring</span><span class="p">,</span> <span class="n">ohdr</span><span class="p">,</span> <span class="n">ogulp_nframe</span><span class="p">,</span> <span class="n">obuf_nframe</span><span class="p">)</span>
                 <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">orings</span><span class="p">,</span> <span class="n">oheaders</span><span class="p">,</span> <span class="n">ogulp_nframes</span><span class="p">,</span> <span class="n">obuf_nframes</span><span class="p">)]</span>

        <span class="c1"># Synchronize all blocks here to ensure no sequence race conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">block_init_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">all_blocks_finished_initializing_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">ogulp_overlaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">ogulp_nframe</span> <span class="o">-</span> <span class="n">ostride_nframe</span>
                          <span class="k">for</span> <span class="n">ogulp_nframe</span><span class="p">,</span> <span class="n">ostride_nframe</span>
                          <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ogulp_nframes</span><span class="p">,</span> <span class="n">ostride_nframes</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">oseqs</span><span class="p">,</span> <span class="n">ogulp_overlaps</span></div>
<div class="viewcode-block" id="Block.reserve_spans"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.reserve_spans">[docs]</a>    <span class="k">def</span> <span class="nf">reserve_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_stack</span><span class="p">,</span> <span class="n">oseqs</span><span class="p">,</span> <span class="n">igulp_nframes</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">ogulp_nframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_define_output_nframes</span><span class="p">(</span><span class="n">igulp_nframes</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">exit_stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">oseq</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">ogulp_nframe</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">oseq</span><span class="p">,</span> <span class="n">ogulp_nframe</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">oseqs</span><span class="p">,</span> <span class="n">ogulp_nframes</span><span class="p">)]</span></div>
<div class="viewcode-block" id="Block.commit_spans"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.commit_spans">[docs]</a>    <span class="k">def</span> <span class="nf">commit_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ospans</span><span class="p">,</span> <span class="n">ostrides_actual</span><span class="p">,</span> <span class="n">ogulp_overlaps</span><span class="p">):</span>
        <span class="c1"># Allow returning None to indicate complete consumption</span>
        <span class="k">if</span> <span class="n">ostrides_actual</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ostrides</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ospans</span><span class="p">)</span>
        <span class="c1"># Note: If ospan.nframe &lt; ogulp_overlap, no frames will be committed</span>
        <span class="n">ostrides</span> <span class="o">=</span> <span class="p">[</span><span class="n">ostride</span> <span class="k">if</span> <span class="n">ostride</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="n">ospan</span><span class="o">.</span><span class="n">nframe</span> <span class="o">-</span> <span class="n">ogulp_overlap</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">ostride</span><span class="p">,</span> <span class="n">ospan</span><span class="p">,</span> <span class="n">ogulp_overlap</span><span class="p">)</span>
                    <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ostrides_actual</span><span class="p">,</span> <span class="n">ospans</span><span class="p">,</span> <span class="n">ogulp_overlaps</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ospan</span><span class="p">,</span> <span class="n">ostride</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ospans</span><span class="p">,</span> <span class="n">ostrides</span><span class="p">):</span>
            <span class="n">ospan</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">ostride</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_define_output_nframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_nframes</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_output_nframes</span><span class="p">(</span><span class="n">input_nframes</span><span class="p">)</span>
<div class="viewcode-block" id="Block.define_output_nframes"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.define_output_nframes">[docs]</a>    <span class="k">def</span> <span class="nf">define_output_nframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_nframes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return output nframe for each output, given input_nframes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
    <span class="k">def</span> <span class="nf">_define_valid_input_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_valid_input_spaces</span><span class="p">()</span>
<div class="viewcode-block" id="Block.define_valid_input_spaces"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.Block.define_valid_input_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">define_valid_input_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return set of valid spaces (or &#39;any&#39;) for each input&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;any&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="SourceBlock"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SourceBlock">[docs]</a><span class="k">class</span> <span class="nc">SourceBlock</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourcenames</span><span class="p">,</span> <span class="n">gulp_nframe</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SourceBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">gulp_nframe</span><span class="o">=</span><span class="n">gulp_nframe</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcenames</span> <span class="o">=</span> <span class="n">sourcenames</span>
        <span class="n">default_space</span> <span class="o">=</span> <span class="s1">&#39;cuda_host&#39;</span> <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">cuda_enabled</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;system&#39;</span>
        <span class="k">if</span> <span class="n">space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">space</span> <span class="o">=</span> <span class="n">default_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">create_ring</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="n">space</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perf_proclog</span> <span class="o">=</span> <span class="n">ProcLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/perf&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_proclog</span> <span class="o">=</span> <span class="n">ProcLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/out&quot;</span><span class="p">)</span>

        <span class="n">rnames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nring&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orings</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orings</span><span class="p">):</span>
            <span class="n">rnames</span><span class="p">[</span><span class="s1">&#39;ring</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_proclog</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rnames</span><span class="p">)</span>

<div class="viewcode-block" id="SourceBlock.main"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SourceBlock.main">[docs]</a>    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orings</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sourcename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourcenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_reader</span><span class="p">(</span><span class="n">sourcename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ireader</span><span class="p">:</span>
                <span class="n">oheaders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_sequence</span><span class="p">(</span><span class="n">ireader</span><span class="p">,</span> <span class="n">sourcename</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ohdr</span> <span class="ow">in</span> <span class="n">oheaders</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;time_tag&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ohdr</span><span class="p">:</span>
                        <span class="n">ohdr</span><span class="p">[</span><span class="s1">&#39;time_tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_count</span>
                    <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ohdr</span><span class="p">:</span>
                        <span class="n">ohdr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unnamed-sequence-</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_count</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_seq_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">oseq_stack</span><span class="p">:</span>
                    <span class="n">oseqs</span><span class="p">,</span> <span class="n">ogulp_overlaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_sequences</span><span class="p">(</span>
                        <span class="n">oseq_stack</span><span class="p">,</span> <span class="n">orings</span><span class="p">,</span> <span class="n">oheaders</span><span class="p">,</span>
                        <span class="n">igulp_nframes</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">istride_nframes</span><span class="o">=</span><span class="p">[])</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">ospan_stack</span><span class="p">:</span>
                            <span class="n">ospans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_spans</span><span class="p">(</span><span class="n">ospan_stack</span><span class="p">,</span> <span class="n">oseqs</span><span class="p">)</span>
                            <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            <span class="n">reserve_time</span> <span class="o">=</span> <span class="n">cur_time</span> <span class="o">-</span> <span class="n">prev_time</span>
                            <span class="n">prev_time</span> <span class="o">=</span> <span class="n">cur_time</span>
                            <span class="n">ostrides_actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_data</span><span class="p">(</span><span class="n">ireader</span><span class="p">,</span> <span class="n">ospans</span><span class="p">)</span>
                            <span class="n">device</span><span class="o">.</span><span class="n">stream_synchronize</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">commit_spans</span><span class="p">(</span><span class="n">ospans</span><span class="p">,</span> <span class="n">ostrides_actual</span><span class="p">,</span> <span class="n">ogulp_overlaps</span><span class="p">)</span>
                            <span class="c1"># TODO: Is this an OK way to detect end-of-data?</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">ostride</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ostride</span> <span class="ow">in</span> <span class="n">ostrides_actual</span><span class="p">]):</span>
                                <span class="k">break</span>
                        <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">process_time</span> <span class="o">=</span> <span class="n">cur_time</span> <span class="o">-</span> <span class="n">prev_time</span>
                        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">cur_time</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">perf_proclog</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s1">&#39;acquire_time&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="s1">&#39;reserve_time&#39;</span><span class="p">:</span> <span class="n">reserve_time</span><span class="p">,</span>
                            <span class="s1">&#39;process_time&#39;</span><span class="p">:</span> <span class="n">process_time</span><span class="p">})</span></div>
<div class="viewcode-block" id="SourceBlock.define_output_nframes"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SourceBlock.define_output_nframes">[docs]</a>    <span class="k">def</span> <span class="nf">define_output_nframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return output nframe for each output, given input_nframes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gulp_nframe</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_outputs</span><span class="p">()</span></div>
<div class="viewcode-block" id="SourceBlock.define_valid_input_spaces"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SourceBlock.define_valid_input_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">define_valid_input_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return set of valid spaces (or &#39;any&#39;) for each input&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>
<div class="viewcode-block" id="SourceBlock.create_reader"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SourceBlock.create_reader">[docs]</a>    <span class="k">def</span> <span class="nf">create_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourcename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an object to use for reading source data&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Should return a dummy reader object here?</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
<div class="viewcode-block" id="SourceBlock.on_sequence"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SourceBlock.on_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">on_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">sourcename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return header for each output&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
<div class="viewcode-block" id="SourceBlock.on_data"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SourceBlock.on_data">[docs]</a>    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">ospans</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process data from from ispans to ospans and return the number of</span>
<span class="sd">        frames to commit for each output.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<span class="k">def</span> <span class="nf">_span_slice</span><span class="p">(</span><span class="n">soft_slice</span><span class="p">):</span>
    <span class="c1"># Infers optional values in soft_slice (i.e., those that are None)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">soft_slice</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span>
                 <span class="n">soft_slice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                 <span class="n">soft_slice</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="p">(</span><span class="n">soft_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

<div class="viewcode-block" id="MultiTransformBlock"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.MultiTransformBlock">[docs]</a><span class="k">class</span> <span class="nc">MultiTransformBlock</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irings_</span><span class="p">,</span> <span class="n">guarantee</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiTransformBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">irings_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Note: Must use self.irings rather than irings_ because they may</span>
        <span class="c1">#         actually be Block instances.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guarantee</span> <span class="o">=</span> <span class="n">guarantee</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">create_ring</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="n">iring</span><span class="o">.</span><span class="n">space</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">iring</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perf_proclog</span> <span class="o">=</span> <span class="n">ProcLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/perf&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_proclogs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ProcLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/sequence</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_proclog</span> <span class="o">=</span> <span class="n">ProcLog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/out&quot;</span><span class="p">)</span>

        <span class="n">rnames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nring&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orings</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orings</span><span class="p">):</span>
            <span class="n">rnames</span><span class="p">[</span><span class="s1">&#39;ring</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_proclog</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rnames</span><span class="p">)</span>

<div class="viewcode-block" id="MultiTransformBlock.main"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.MultiTransformBlock.main">[docs]</a>    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orings</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iseqs</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">iring</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">guarantee</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">guarantee</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">iring</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iseq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iseqs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sequence_proclogs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iseq</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">oheaders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_sequence</span><span class="p">(</span><span class="n">iseqs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ohdr</span> <span class="ow">in</span> <span class="n">oheaders</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;time_tag&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ohdr</span><span class="p">:</span>
                    <span class="n">ohdr</span><span class="p">[</span><span class="s1">&#39;time_tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seq_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">igulp_nframes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gulp_nframe</span> <span class="ow">or</span> <span class="n">iseq</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;gulp_nframe&#39;</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">iseq</span> <span class="ow">in</span> <span class="n">iseqs</span><span class="p">]</span>
            <span class="n">igulp_overlaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_define_input_overlap_nframe</span><span class="p">(</span><span class="n">iseqs</span><span class="p">)</span>
            <span class="n">istride_nframes</span> <span class="o">=</span> <span class="n">igulp_nframes</span><span class="p">[:]</span>
            <span class="n">igulp_nframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">igulp_nframe</span> <span class="o">+</span> <span class="n">nframe_overlap</span>
                             <span class="k">for</span> <span class="n">igulp_nframe</span><span class="p">,</span> <span class="n">nframe_overlap</span>
                             <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">igulp_nframes</span><span class="p">,</span> <span class="n">igulp_overlaps</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">iseq</span><span class="p">,</span> <span class="n">igulp_nframe</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iseqs</span><span class="p">,</span> <span class="n">igulp_nframes</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">src_block</span> <span class="o">=</span> <span class="n">iseq</span><span class="o">.</span><span class="n">ring</span><span class="o">.</span><span class="n">owner</span>
                    <span class="k">if</span> <span class="n">src_block</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fused_with</span><span class="p">(</span><span class="n">src_block</span><span class="p">):</span>
                        <span class="n">buffer_factor</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">buffer_factor</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">buffer_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_factor</span>
                <span class="n">iseq</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">gulp_nframe</span><span class="o">=</span><span class="n">igulp_nframe</span><span class="p">,</span>
                            <span class="n">buf_nframe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_nframe</span><span class="p">,</span>
                            <span class="n">buffer_factor</span><span class="o">=</span><span class="n">buffer_factor</span><span class="p">)</span>

            <span class="c1"># TODO: Ever need to specify starting offset?</span>
            <span class="n">iframe0s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">igulp_nframes</span><span class="p">]</span>

            <span class="n">force_skip</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">oseq_stack</span><span class="p">:</span>
                <span class="n">oseqs</span><span class="p">,</span> <span class="n">ogulp_overlaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_sequences</span><span class="p">(</span>
                    <span class="n">oseq_stack</span><span class="p">,</span> <span class="n">orings</span><span class="p">,</span> <span class="n">oheaders</span><span class="p">,</span>
                    <span class="n">igulp_nframes</span><span class="p">,</span> <span class="n">istride_nframes</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">break</span>
                <span class="n">prev_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ispans</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">iseq</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">igulp_nframe</span><span class="p">,</span>
                                               <span class="n">istride_nframe</span><span class="p">,</span>
                                               <span class="n">iframe0</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="p">(</span><span class="n">iseq</span><span class="p">,</span> <span class="n">igulp_nframe</span><span class="p">,</span> <span class="n">istride_nframe</span><span class="p">,</span> <span class="n">iframe0</span><span class="p">)</span>
                                    <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iseqs</span><span class="p">,</span> <span class="n">igulp_nframes</span><span class="p">,</span> <span class="n">istride_nframes</span><span class="p">,</span> <span class="n">iframe0s</span><span class="p">)]):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="k">return</span>

                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">ispan</span><span class="o">.</span><span class="n">nframe_skipped</span> <span class="k">for</span> <span class="n">ispan</span> <span class="ow">in</span> <span class="n">ispans</span><span class="p">]):</span>
                        <span class="c1"># There were skipped (overwritten) frames</span>
                        <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">ospan_stack</span><span class="p">:</span>
                            <span class="n">iskip_slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">iframe0</span><span class="p">,</span>
                                                  <span class="n">iframe0</span> <span class="o">+</span> <span class="n">ispan</span><span class="o">.</span><span class="n">nframe_skipped</span><span class="p">,</span>
                                                  <span class="n">istride_nframe</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">iframe0</span><span class="p">,</span> <span class="n">istride_nframe</span><span class="p">,</span> <span class="n">ispan</span> <span class="ow">in</span>
                                            <span class="nb">zip</span><span class="p">(</span><span class="n">iframe0s</span><span class="p">,</span> <span class="n">istride_nframes</span><span class="p">,</span> <span class="n">ispans</span><span class="p">)]</span>
                            <span class="n">iskip_nframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ispan</span><span class="o">.</span><span class="n">nframe_skipped</span>
                                             <span class="k">for</span> <span class="n">ispan</span> <span class="ow">in</span> <span class="n">ispans</span><span class="p">]</span>
                            <span class="c1"># ***TODO: Need to loop over multiple ospans here,</span>
                            <span class="c1">#            because iskip_nframes can be</span>
                            <span class="c1">#            arbitrarily large!</span>
                            <span class="n">ospans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_spans</span><span class="p">(</span><span class="n">ospan_stack</span><span class="p">,</span> <span class="n">oseqs</span><span class="p">,</span> <span class="n">iskip_nframes</span><span class="p">)</span>
                            <span class="n">ostrides_actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_skip</span><span class="p">(</span><span class="n">iskip_slices</span><span class="p">,</span> <span class="n">ospans</span><span class="p">)</span>
                            <span class="n">device</span><span class="o">.</span><span class="n">stream_synchronize</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">commit_spans</span><span class="p">(</span><span class="n">ospans</span><span class="p">,</span> <span class="n">ostrides_actual</span><span class="p">,</span> <span class="n">ogulp_overlaps</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">ispan</span><span class="o">.</span><span class="n">nframe</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ispan</span> <span class="ow">in</span> <span class="n">ispans</span><span class="p">]):</span>
                        <span class="c1"># No data to see here, move right along</span>
                        <span class="k">continue</span>

                    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">acquire_time</span> <span class="o">=</span> <span class="n">cur_time</span> <span class="o">-</span> <span class="n">prev_time</span>
                    <span class="n">prev_time</span> <span class="o">=</span> <span class="n">cur_time</span>

                    <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">ospan_stack</span><span class="p">:</span>
                        <span class="n">igulp_nframes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ispan</span><span class="o">.</span><span class="n">nframe</span> <span class="k">for</span> <span class="n">ispan</span> <span class="ow">in</span> <span class="n">ispans</span><span class="p">]</span>
                        <span class="n">ospans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_spans</span><span class="p">(</span><span class="n">ospan_stack</span><span class="p">,</span> <span class="n">oseqs</span><span class="p">,</span> <span class="n">igulp_nframes</span><span class="p">)</span>
                        <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">reserve_time</span> <span class="o">=</span> <span class="n">cur_time</span> <span class="o">-</span> <span class="n">prev_time</span>
                        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">cur_time</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_skip</span><span class="p">:</span>
                            <span class="c1"># *TODO: See if can fuse together multiple on_data calls here before</span>
                            <span class="c1">#          calling stream_synchronize().</span>
                            <span class="c1">#        Consider passing .data instead of rings here</span>
                            <span class="n">ostrides_actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_data</span><span class="p">(</span><span class="n">ispans</span><span class="p">,</span> <span class="n">ospans</span><span class="p">)</span>
                            <span class="n">device</span><span class="o">.</span><span class="n">stream_synchronize</span><span class="p">()</span>

                        <span class="n">any_frames_overwritten</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">ispan</span><span class="o">.</span><span class="n">nframe_overwritten</span>
                                                      <span class="k">for</span> <span class="n">ispan</span> <span class="ow">in</span> <span class="n">ispans</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">force_skip</span> <span class="ow">or</span> <span class="n">any_frames_overwritten</span><span class="p">:</span>
                            <span class="c1"># Note: To allow interrupted pipelines to catch up,</span>
                            <span class="c1">#         we force-skip an additional gulp whenever</span>
                            <span class="c1">#         a span is overwritten during on_data.</span>
                            <span class="n">force_skip</span> <span class="o">=</span> <span class="n">any_frames_overwritten</span>
                            <span class="n">iskip_slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">ispan</span><span class="o">.</span><span class="n">frame_offset</span><span class="p">,</span>
                                                  <span class="n">ispan</span><span class="o">.</span><span class="n">frame_offset</span> <span class="o">+</span> <span class="n">ispan</span><span class="o">.</span><span class="n">nframe_overwritten</span><span class="p">,</span>
                                                  <span class="n">istride_nframe</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">ispan</span><span class="p">,</span> <span class="n">istride_nframe</span>
                                            <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ispans</span><span class="p">,</span> <span class="n">istride_nframes</span><span class="p">)]</span>
                            <span class="n">ostrides_actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_skip</span><span class="p">(</span><span class="n">iskip_slices</span><span class="p">,</span> <span class="n">ospans</span><span class="p">)</span>
                            <span class="n">device</span><span class="o">.</span><span class="n">stream_synchronize</span><span class="p">()</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">commit_spans</span><span class="p">(</span><span class="n">ospans</span><span class="p">,</span> <span class="n">ostrides_actual</span><span class="p">,</span> <span class="n">ogulp_overlaps</span><span class="p">)</span>
                    <span class="n">cur_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">process_time</span> <span class="o">=</span> <span class="n">cur_time</span> <span class="o">-</span> <span class="n">prev_time</span>
                    <span class="n">prev_time</span> <span class="o">=</span> <span class="n">cur_time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">perf_proclog</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;acquire_time&#39;</span><span class="p">:</span> <span class="n">acquire_time</span><span class="p">,</span>
                        <span class="s1">&#39;reserve_time&#39;</span><span class="p">:</span> <span class="n">reserve_time</span><span class="p">,</span>
                        <span class="s1">&#39;process_time&#39;</span><span class="p">:</span> <span class="n">process_time</span><span class="p">})</span>
            <span class="c1"># **TODO: This will not be called if an exception is raised</span>
            <span class="c1">#           Need to call it from a context manager somehow</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_sequence_end</span><span class="p">(</span><span class="n">iseqs</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_on_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_sequence</span><span class="p">(</span><span class="n">iseqs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_sequence_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_sequence_end</span><span class="p">(</span><span class="n">iseqs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ispans</span><span class="p">,</span> <span class="n">ospans</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_data</span><span class="p">(</span><span class="n">ispans</span><span class="p">,</span> <span class="n">ospans</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">islices</span><span class="p">,</span> <span class="n">ospans</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_skip</span><span class="p">(</span><span class="n">islices</span><span class="p">,</span> <span class="n">ospans</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_define_input_overlap_nframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_input_overlap_nframe</span><span class="p">(</span><span class="n">iseqs</span><span class="p">)</span>
<div class="viewcode-block" id="MultiTransformBlock.define_input_overlap_nframe"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.MultiTransformBlock.define_input_overlap_nframe">[docs]</a>    <span class="k">def</span> <span class="nf">define_input_overlap_nframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return no. input frames that should overlap between successive spans</span>
<span class="sd">        for each input sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">)</span></div>
<div class="viewcode-block" id="MultiTransformBlock.define_output_nframes"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.MultiTransformBlock.define_output_nframes">[docs]</a>    <span class="k">def</span> <span class="nf">define_output_nframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_nframes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return output nframe for each output, given input_nframes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">input_nframes</span></div>
<div class="viewcode-block" id="MultiTransformBlock.on_sequence"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.MultiTransformBlock.on_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">on_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return: oheaders (one per output)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
<div class="viewcode-block" id="MultiTransformBlock.on_sequence_end"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.MultiTransformBlock.on_sequence_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_sequence_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do any necessary cleanup&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
<div class="viewcode-block" id="MultiTransformBlock.on_data"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.MultiTransformBlock.on_data">[docs]</a>    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ispans</span><span class="p">,</span> <span class="n">ospans</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process data from from ispans to ospans and return the number of</span>
<span class="sd">        frames to commit for each output (or None to commit complete spans).&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
<div class="viewcode-block" id="MultiTransformBlock.on_skip"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.MultiTransformBlock.on_skip">[docs]</a>    <span class="k">def</span> <span class="nf">on_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">islices</span><span class="p">,</span> <span class="n">ospans</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle skipped frames&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>

<div class="viewcode-block" id="TransformBlock"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.TransformBlock">[docs]</a><span class="k">class</span> <span class="nc">TransformBlock</span><span class="p">(</span><span class="n">MultiTransformBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iring</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TransformBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([</span><span class="n">iring</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_define_valid_input_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">spaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_valid_input_spaces</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">spaces</span><span class="p">]</span>
<div class="viewcode-block" id="TransformBlock.define_valid_input_spaces"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.TransformBlock.define_valid_input_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">define_valid_input_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return set of valid spaces (or &#39;any&#39;) for the input&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;any&#39;</span></div>
    <span class="k">def</span> <span class="nf">_define_input_overlap_nframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">define_input_overlap_nframe</span><span class="p">(</span><span class="n">iseqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<div class="viewcode-block" id="TransformBlock.define_input_overlap_nframe"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.TransformBlock.define_input_overlap_nframe">[docs]</a>    <span class="k">def</span> <span class="nf">define_input_overlap_nframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return no. input frames that should overlap between successive spans.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span></div>
    <span class="k">def</span> <span class="nf">_define_output_nframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_nframes</span><span class="p">):</span>
        <span class="n">output_nframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_output_nframes</span><span class="p">(</span><span class="n">input_nframes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">output_nframe</span><span class="p">]</span>
<div class="viewcode-block" id="TransformBlock.define_output_nframes"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.TransformBlock.define_output_nframes">[docs]</a>    <span class="k">def</span> <span class="nf">define_output_nframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_nframe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return number of frames that will be produced given input_nframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">input_nframe</span></div>
    <span class="k">def</span> <span class="nf">_on_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">on_sequence</span><span class="p">(</span><span class="n">iseqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<div class="viewcode-block" id="TransformBlock.on_sequence"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.TransformBlock.on_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">on_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return oheader&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
    <span class="k">def</span> <span class="nf">_on_sequence_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">on_sequence_end</span><span class="p">(</span><span class="n">iseqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<div class="viewcode-block" id="TransformBlock.on_sequence_end"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.TransformBlock.on_sequence_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_sequence_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do any necessary cleanup&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    <span class="k">def</span> <span class="nf">_on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ispans</span><span class="p">,</span> <span class="n">ospans</span><span class="p">):</span>
        <span class="n">nframe_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_data</span><span class="p">(</span><span class="n">ispans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ospans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">nframe_commit</span><span class="p">]</span>
<div class="viewcode-block" id="TransformBlock.on_data"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.TransformBlock.on_data">[docs]</a>    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ispan</span><span class="p">,</span> <span class="n">ospan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of output frames to commit, or None to commit all</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
    <span class="k">def</span> <span class="nf">_on_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">islices</span><span class="p">,</span> <span class="n">ospans</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">on_skip</span><span class="p">(</span><span class="n">islices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ospans</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<div class="viewcode-block" id="TransformBlock.on_skip"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.TransformBlock.on_skip">[docs]</a>    <span class="k">def</span> <span class="nf">on_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">islice</span><span class="p">,</span> <span class="n">ospan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle skipped frames&quot;&quot;&quot;</span>
        <span class="c1"># Note: This zeros the whole gulp, even though only part of the gulp</span>
        <span class="c1">#         may have been overwritten.</span>
        <span class="n">memset_array</span><span class="p">(</span><span class="n">ospan</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div></div>
        <span class="c1">#for i in range(0, ispan.nframe_skipped, igulp_nframe):</span>
        <span class="c1">#    inframe = min(igulp_nframe, inskipped - i)</span>
        <span class="c1">#    onframe = self._define_output_nframes(inframe)</span>
        <span class="c1">#    with oseq.reserve(onframe) as ospan:</span>
        <span class="c1">#        bf.ndarray.memset_array(ospan.data, 0)</span>

<span class="c1"># TODO: Need something like on_sequence_end to allow closing open files etc.</span>
<div class="viewcode-block" id="SinkBlock"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SinkBlock">[docs]</a><span class="k">class</span> <span class="nc">SinkBlock</span><span class="p">(</span><span class="n">MultiTransformBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iring</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SinkBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">([</span><span class="n">iring</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iring</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">irings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_define_valid_input_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">spaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_valid_input_spaces</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">spaces</span><span class="p">]</span>
<div class="viewcode-block" id="SinkBlock.define_valid_input_spaces"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SinkBlock.define_valid_input_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">define_valid_input_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return set of valid spaces (or &#39;any&#39;) for the input&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;any&#39;</span></div>
    <span class="k">def</span> <span class="nf">_define_input_overlap_nframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">define_input_overlap_nframe</span><span class="p">(</span><span class="n">iseqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<div class="viewcode-block" id="SinkBlock.define_input_overlap_nframe"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SinkBlock.define_input_overlap_nframe">[docs]</a>    <span class="k">def</span> <span class="nf">define_input_overlap_nframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return no. input frames that should overlap between successive spans.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span></div>
    <span class="k">def</span> <span class="nf">_define_output_nframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_nframes</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">_on_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_sequence</span><span class="p">(</span><span class="n">iseqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[]</span>
<div class="viewcode-block" id="SinkBlock.on_sequence"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SinkBlock.on_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">on_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return islice or None to use simple striding&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
    <span class="k">def</span> <span class="nf">_on_sequence_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseqs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">on_sequence_end</span><span class="p">(</span><span class="n">iseqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<div class="viewcode-block" id="SinkBlock.on_sequence_end"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SinkBlock.on_sequence_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_sequence_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iseq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do any necessary cleanup&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
    <span class="k">def</span> <span class="nf">_on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ispans</span><span class="p">,</span> <span class="n">ospans</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_data</span><span class="p">(</span><span class="n">ispans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[]</span>
<div class="viewcode-block" id="SinkBlock.on_data"><a class="viewcode-back" href="../../bifrost.html#bifrost.pipeline.SinkBlock.on_data">[docs]</a>    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ispan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return nothing&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">bifrost</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">1. Introduction to Bifrost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Getting-started-guide.html">2. Getting started guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Create-a-pipeline.html">3. Create a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../your-first-blocks.html">4. Your first blocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../views.html">5. Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools-intro.html">6. Monitoring Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bfmap.html">7. Fast GPU math using bfMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../How-Python-and-C---fits-together.html">8. How bifrost fits together</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Common-installation-and-execution-problems.html">9. Common Installation and Execution Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bifrost.blocks.html">10. Block Library Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bifrost.html">11. Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Cpp-Development.html">12. C++ Developement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpp_reference.html">13. C++ Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;1980, ledatelescope.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>