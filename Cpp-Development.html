
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>12. C++ Developement &#8212; bifrost 0.6 documentation</title>
    <link rel="stylesheet" type="text/css" href="static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="static/documentation_options.js"></script>
    <script src="static/jquery.js"></script>
    <script src="static/underscore.js"></script>
    <script src="static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="13. C++ Reference" href="cpp_reference.html" />
    <link rel="prev" title="11.1.2. bifrost.views package" href="bifrost.views.html" />
   
  <link rel="stylesheet" href="static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="c-developement">
<h1><span class="section-number">12. </span>C++ Developement<a class="headerlink" href="#c-developement" title="Permalink to this headline">¶</a></h1>
<p>If you are interested in creating additional functionality for Bifrost,
this document should help you get up and running with the Bifrost C++
API.</p>
<section id="create-a-ring-buffer-and-load-data">
<h2><span class="section-number">12.1. </span>Create a Ring Buffer and Load Data<a class="headerlink" href="#create-a-ring-buffer-and-load-data" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime_api.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bifrost/common.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bifrost/ring.h&gt;</span><span class="cp"></span>

<span class="p">...</span><span class="w"></span>

<span class="c1">//////////////////////////////////</span>
<span class="c1">//Create and write to a ring</span>
<span class="c1">/////////////////////////////////</span>

<span class="n">BFring</span><span class="w"> </span><span class="n">my_ring</span><span class="p">;</span><span class="w"> </span><span class="c1">//declare our ring variable</span>
<span class="n">bfRingCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_ring</span><span class="p">,</span><span class="w"> </span><span class="n">BF_SPACE_SYSTEM</span><span class="p">);</span><span class="w"> </span><span class="c1">//initiate this ring on local memory (=BF_SPACE_SYSTEM)</span>
<span class="n">bfRingBeginWriting</span><span class="p">(</span><span class="n">my_ring</span><span class="p">);</span><span class="w"> </span><span class="c1">//begin writing to this ring</span>
<span class="c1">//generate some dummy variables</span>
<span class="n">BFoffset</span><span class="w"> </span><span class="n">skip_time_tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="n">BFoffset</span><span class="w"> </span><span class="n">skip_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="n">BFsize</span><span class="w"> </span><span class="n">my_header_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">my_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span><span class="w"></span>
<span class="c1">//Set our ring variables</span>
<span class="n">BFsize</span><span class="w"> </span><span class="n">nringlets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">//dimensionality of our ring.</span>
<span class="n">BFsize</span><span class="w"> </span><span class="n">nbytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="c1">//number of bytes we are putting in</span>
<span class="n">BFsize</span><span class="w"> </span><span class="n">buffer_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="n">nbytes</span><span class="p">;</span><span class="w"></span>
<span class="c1">//resize ring to fit the data</span>
<span class="n">bfRingResize</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">my_ring</span><span class="p">,</span><span class="w"> </span><span class="n">nbytes</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">nringlets</span><span class="p">);</span><span class="w"></span>
<span class="c1">//open a sequence on the ring.</span>
<span class="n">BFwsequence</span><span class="w"> </span><span class="n">my_sequence</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mysequence&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">//we can find our sequence by this name later on</span>
<span class="n">bfRingSequenceBegin</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">my_sequence</span><span class="p">,</span><span class="w"> </span><span class="n">my_ring</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">skip_time_tag</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">my_header_size</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">my_header</span><span class="p">,</span><span class="w"> </span><span class="n">nringlets</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">skip_offset</span><span class="p">);</span><span class="w"></span>
<span class="c1">//reserve a &quot;span&quot; on this sequence to put our data</span>
<span class="n">BFwspan</span><span class="w"> </span><span class="n">my_span</span><span class="p">;</span><span class="w"></span>
<span class="n">bfRingSpanReserve</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">my_span</span><span class="p">,</span><span class="w"> </span><span class="n">my_ring</span><span class="p">,</span><span class="w"> </span><span class="n">nbytes</span><span class="p">);</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data_access</span><span class="p">;</span><span class="w"> </span><span class="c1">//create a pointer to pass our data to</span>
<span class="c1">//create the data and copy it to the ring</span>
<span class="kt">float</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">-10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">-3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="n">bfRingSpanGetData</span><span class="p">((</span><span class="n">BFspan</span><span class="p">)</span><span class="n">my_span</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data_access</span><span class="p">);</span><span class="w"> </span><span class="c1">//point our pointer to the span&#39;s allocated memory</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">data_access</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">nbytes</span><span class="p">);</span><span class="w"></span>
<span class="c1">//stop writing</span>
<span class="n">bfRingSpanCommit</span><span class="p">(</span><span class="n">my_span</span><span class="p">,</span><span class="w"> </span><span class="n">nbytes</span><span class="p">);</span><span class="w"> </span><span class="c1">//commit this span to memory</span>
<span class="n">bfRingSequenceEnd</span><span class="p">(</span><span class="n">my_sequence</span><span class="p">,</span><span class="w"> </span><span class="n">skip_offset</span><span class="p">);</span><span class="w"> </span><span class="c1">//end off the sequence</span>
<span class="n">bfRingEndWriting</span><span class="p">(</span><span class="n">my_ring</span><span class="p">);</span><span class="w"></span>

<span class="c1">//////////////////////////////////</span>
<span class="c1">//Read from the ring</span>
<span class="c1">/////////////////////////////////</span>

<span class="n">nbytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="c1">//the size of the data we want to read</span>
<span class="c1">//open the last accessed sequence</span>
<span class="n">BFrsequence</span><span class="w"> </span><span class="n">my_read_sequence</span><span class="p">;</span><span class="w"></span>
<span class="n">bfRingSequenceOpenLatest</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">my_read_sequence</span><span class="p">,</span><span class="w"> </span><span class="n">my_ring</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="c1">//open a span on this sequence</span>
<span class="n">BFrspan</span><span class="w"> </span><span class="n">my_read_span</span><span class="p">;</span><span class="w"></span>
<span class="n">bfRingSpanAcquire</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">my_read_span</span><span class="p">,</span><span class="w"> </span><span class="n">my_read_sequence</span><span class="p">,</span><span class="w"> </span><span class="n">skip_offset</span><span class="p">,</span><span class="w"> </span><span class="n">nbytes</span><span class="p">);</span><span class="w"></span>
<span class="c1">//Access the data from the span with a pointer</span>
<span class="n">bfRingSpanGetData</span><span class="p">((</span><span class="n">BFspan</span><span class="p">)</span><span class="n">my_read_span</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data_access</span><span class="p">);</span><span class="w"></span>
<span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">my_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data_access</span><span class="p">);</span><span class="w"> </span><span class="c1">//Copy the data into a readable format</span>
<span class="c1">//print out the ring data</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">my_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">//close up our ring access</span>
<span class="n">bfRingSpanRelease</span><span class="p">(</span><span class="n">my_read_span</span><span class="p">);</span><span class="w"></span>
<span class="n">bfRingSequenceClose</span><span class="p">(</span><span class="n">my_read_sequence</span><span class="p">);</span><span class="w"></span>
<span class="n">bfRingDestroy</span><span class="p">(</span><span class="n">my_ring</span><span class="p">);</span><span class="w"> </span><span class="c1">//delete the ring from memory</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">bifrost</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduction to Bifrost</a></li>
<li class="toctree-l1"><a class="reference internal" href="Getting-started-guide.html">2. Getting started guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Create-a-pipeline.html">3. Create a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="your-first-blocks.html">4. Your first blocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="views.html">5. Views</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools-intro.html">6. Monitoring Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="bfmap.html">7. Fast GPU math using bfMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="How-Python-and-C---fits-together.html">8. How bifrost fits together</a></li>
<li class="toctree-l1"><a class="reference internal" href="Common-installation-and-execution-problems.html">9. Common Installation and Execution Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="bifrost.blocks.html">10. Block Library Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="bifrost.html">11. Python Reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">12. C++ Developement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#create-a-ring-buffer-and-load-data">12.1. Create a Ring Buffer and Load Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cpp_reference.html">13. C++ Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="bifrost.views.html" title="previous chapter"><span class="section-number">11.1.2. </span>bifrost.views package</a></li>
      <li>Next: <a href="cpp_reference.html" title="next chapter"><span class="section-number">13. </span>C++ Reference</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;1980, ledatelescope.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="sources/Cpp-Development.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>